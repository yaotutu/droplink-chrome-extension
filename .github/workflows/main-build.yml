name: Chrome Extension Main Build

on:
  # æŽ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main

  # PR æ£€æŸ¥
  pull_request:
    branches:
      - main

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æŽˆäºˆ GitHub Actions åˆ›å»º Release çš„æƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»º/æ›´æ–° Release å’Œ Tag

jobs:
  build:
    name: æž„å»º Release ç‰ˆæœ¬
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•ï¼Œç”¨äºŽè®¡ç®—æäº¤æ€»æ•°

      # è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # è®¾ç½® pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      # èŽ·å– pnpm store ç›®å½•
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # ç¼“å­˜ä¾èµ–
      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # è®¾ç½®ç‰ˆæœ¬å·ï¼ˆä»Ž package.json è¯»å–ï¼Œç¡®ä¿ä¸€è‡´æ€§ï¼‰
      - name: è®¾ç½®ç‰ˆæœ¬å·
        id: version
        run: |
          # ä»Ž package.json è¯»å–ç‰ˆæœ¬å·ï¼ˆå•ä¸€æ•°æ®æºï¼‰
          VERSION_NAME=$(node -p "require('./package.json').version")
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          COMMIT_COUNT=$(git rev-list --count HEAD)

          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV

          echo "ðŸ“¦ Release ç‰ˆæœ¬å·: $VERSION_NAME"
          echo "ðŸ“Š Git æäº¤æ€»æ•°: $COMMIT_COUNT"
          echo "ðŸ• æž„å»ºæ—¶é—´: $BUILD_TIME"
          echo ""
          echo "âœ… ç‰ˆæœ¬å·æ¥æº: package.json (å•ä¸€æ•°æ®æº)"

      # æž„å»ºæ‰©å±•
      - name: Build extension
        run: pnpm build

      # æ‰“åŒ…æ‰©å±•
      - name: Package extension
        run: pnpm package

      # é‡å‘½å zip æ–‡ä»¶
      - name: Rename package
        run: |
          mkdir -p output
          cp build/chrome-mv3-prod.zip output/droplink-v${{ env.VERSION_NAME }}.zip
          echo "âœ… æ‰©å±•åŒ…å·²é‡å‘½åä¸º: droplink-release-${{ env.VERSION_NAME }}.zip"

      # ä¸Šä¼ æž„å»ºäº§ç‰©åˆ° Artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: droplink-v${{ env.VERSION_NAME }}
          path: output/droplink-v${{ env.VERSION_NAME }}.zip
          retention-days: 90

      # è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Release (è¦†ç›–å¼å‘å¸ƒ main-latest)
      - name: Create or Update Main Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: main-latest
          name: "âœ… æ­£å¼ç‰ˆ v${{ env.VERSION_NAME }} (æœ€æ–°ç¨³å®šç‰ˆ)"
          body: |
            ## ðŸ“¦ Droplink Chrome Extension æ­£å¼ç‰ˆ

            **ç‰ˆæœ¬å·**: `v${{ env.VERSION_NAME }}`
            **æž„å»ºåˆ†æ”¯**: `main`
            **æäº¤ SHA**: `${{ github.sha }}`
            **æäº¤æ€»æ•°**: `${{ env.COMMIT_COUNT }}`
            **æž„å»ºæ—¶é—´**: `${{ env.BUILD_TIME }}`

            ---

            ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
            - è¿™æ˜¯**æ­£å¼ç¨³å®šç‰ˆæœ¬**ï¼Œå·²é€šè¿‡å®Œæ•´æµ‹è¯•
            - æ¯æ¬¡ main åˆ†æ”¯æ›´æ–°æ—¶ï¼Œæ­¤ Release ä¼šè¢«**è‡ªåŠ¨è¦†ç›–**
            - å¦‚éœ€æµ‹è¯•æœ€æ–°åŠŸèƒ½ï¼Œè¯·è®¿é—® [Dev å¼€å‘ç‰ˆ Release](../../releases/tag/dev-latest)

            ### ðŸ”— å›ºå®šä¸‹è½½é“¾æŽ¥ï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼‰
            ```
            https://github.com/${{ github.repository }}/releases/download/main-latest/droplink-v${{ env.VERSION_NAME }}.zip
            ```

            ### ðŸ“¦ å®‰è£…æ–¹æ³•
            1. ä¸‹è½½ä¸Šé¢çš„ zip æ–‡ä»¶
            2. è§£åŽ‹ç¼©æ–‡ä»¶
            3. æ‰“å¼€ Chrome æµè§ˆå™¨ï¼Œè¿›å…¥ `chrome://extensions/`
            4. å¼€å¯å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£åŽ‹çš„æ‰©å±•ç¨‹åº"
            6. é€‰æ‹©è§£åŽ‹åŽçš„æ–‡ä»¶å¤¹

            ### ðŸ“ æœ€è¿‘æäº¤
            ${{ github.event.head_commit.message }}
          files: output/droplink-v${{ env.VERSION_NAME }}.zip
          draft: false
          prerelease: false  # æ ‡è®°ä¸ºæ­£å¼ç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æž„å»ºä¿¡æ¯æ‘˜è¦
      - name: Build summary
        if: success()
        run: |
          echo "## âœ… Release æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·**: v${{ env.VERSION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤æ€»æ•°**: ${{ env.COMMIT_COUNT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: ${{ env.BUILD_TIME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ å›ºå®šä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/download/main-latest/droplink-v${{ env.VERSION_NAME }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
