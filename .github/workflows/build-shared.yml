name: Shared Build Workflow

# å¯å¤ç”¨çš„ workflowï¼Œè¢« dev-build å’Œ main-build è°ƒç”¨
on:
  workflow_call:
    inputs:
      branch_name:
        description: 'åˆ†æ”¯åç§°ï¼ˆdev/masterï¼‰'
        required: true
        type: string
      release_tag:
        description: 'Release æ ‡ç­¾ï¼ˆdev-latest/main-latestï¼‰'
        required: true
        type: string
      release_title:
        description: 'Release æ ‡é¢˜'
        required: true
        type: string
      use_commit_count:
        description: 'æ˜¯å¦ä½¿ç”¨æäº¤è®¡æ•°ä½œä¸ºç‰ˆæœ¬å·'
        required: true
        type: boolean
      file_prefix:
        description: 'æ–‡ä»¶åå‰ç¼€ï¼ˆdroplink-dev/droplink-vï¼‰'
        required: true
        type: string
      is_prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: true
        type: boolean
      create_version_tag:
        description: 'æ˜¯å¦åˆ›å»ºç‰ˆæœ¬ tag ç”¨äºŽåŽ†å²å½’æ¡£'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    name: æž„å»ºæ‰©å±•
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•

      # è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # è®¾ç½® pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      # èŽ·å– pnpm store ç›®å½•
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # ç¼“å­˜ä¾èµ–
      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # è®¾ç½®ç‰ˆæœ¬å·
      - name: è®¾ç½®ç‰ˆæœ¬å·
        id: version
        run: |
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          COMMIT_COUNT=$(git rev-list --count HEAD)

          if [ "${{ inputs.use_commit_count }}" = "true" ]; then
            # Dev ç‰ˆæœ¬ï¼šä½¿ç”¨æäº¤è®¡æ•°
            VERSION_NAME="1.0.${COMMIT_COUNT}-dev"
            echo "ðŸ“¦ Dev ç‰ˆæœ¬å·: $VERSION_NAME"
            echo "ðŸ“Š åŸºäºŽ Git æäº¤æ€»æ•°: $COMMIT_COUNT"
            # æ›´æ–° package.jsonï¼ˆä»…ç”¨äºŽæž„å»ºï¼‰
            npm version $VERSION_NAME --no-git-tag-version --allow-same-version
          else
            # æ­£å¼ç‰ˆæœ¬ï¼šä»Ž package.json è¯»å–
            VERSION_NAME=$(node -p "require('./package.json').version")
            echo "ðŸ“¦ Release ç‰ˆæœ¬å·: $VERSION_NAME"
            echo "ðŸ“Š Git æäº¤æ€»æ•°: $COMMIT_COUNT"
            echo "âœ… ç‰ˆæœ¬å·æ¥æº: package.json (å•ä¸€æ•°æ®æº)"
          fi

          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV
          echo "ðŸ• æž„å»ºæ—¶é—´: $BUILD_TIME"

      # æž„å»ºæ‰©å±•
      - name: Build extension
        run: pnpm build

      # æ‰“åŒ…æ‰©å±•
      - name: Package extension
        run: pnpm package

      # é‡å‘½å zip æ–‡ä»¶
      - name: Rename package
        run: |
          mkdir -p output
          cp build/chrome-mv3-prod.zip output/${{ inputs.file_prefix }}${{ env.VERSION_NAME }}.zip
          echo "âœ… æ‰©å±•åŒ…å·²é‡å‘½åä¸º: ${{ inputs.file_prefix }}${{ env.VERSION_NAME }}.zip"

      # ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.file_prefix }}${{ env.VERSION_NAME }}
          path: output/${{ inputs.file_prefix }}${{ env.VERSION_NAME }}.zip
          retention-days: ${{ inputs.is_prerelease && 30 || 90 }}

      # åˆ›å»ºæˆ–æ›´æ–° tagï¼ˆä»… dev éœ€è¦ï¼‰
      - name: Create or Update tag
        if: inputs.is_prerelease
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f ${{ inputs.release_tag }}
          git push -f origin ${{ inputs.release_tag }}
          echo "âœ… ${{ inputs.release_tag }} tag å·²åˆ›å»º/æ›´æ–°"

      # åˆ›å»ºç‰ˆæœ¬ tag ç”¨äºŽåŽ†å²å½’æ¡£ï¼ˆä»…æ­£å¼ç‰ˆéœ€è¦ï¼‰
      - name: Create version tag for archive
        if: inputs.create_version_tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          VERSION_TAG="v${{ env.VERSION_NAME }}"

          # æ£€æŸ¥ tag æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "$VERSION_TAG" >/dev/null 2>&1; then
            echo "âš ï¸ Tag $VERSION_TAG å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            git tag "$VERSION_TAG"
            git push origin "$VERSION_TAG"
            echo "âœ… ç‰ˆæœ¬ tag $VERSION_TAG å·²åˆ›å»ºç”¨äºŽåŽ†å²å½’æ¡£"
          fi

      # è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Release
      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_title }}
          body: |
            ## ðŸ“¦ Droplink Chrome Extension

            **ç‰ˆæœ¬å·**: `${{ env.VERSION_NAME }}`
            **æž„å»ºåˆ†æ”¯**: `${{ inputs.branch_name }}`
            **æäº¤ SHA**: `${{ github.sha }}`
            **æäº¤æ€»æ•°**: `${{ env.COMMIT_COUNT }}`
            **æž„å»ºæ—¶é—´**: `${{ env.BUILD_TIME }}`

            ---

            ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
            ${{ inputs.is_prerelease && '- è¿™æ˜¯**å¼€å‘æµ‹è¯•ç‰ˆæœ¬**ï¼Œå¯èƒ½åŒ…å«æœªå®Œæˆçš„åŠŸèƒ½æˆ– Bug' || '- è¿™æ˜¯**æ­£å¼ç¨³å®šç‰ˆæœ¬**ï¼Œå·²é€šè¿‡å®Œæ•´æµ‹è¯•' }}
            - æ¯æ¬¡ ${{ inputs.branch_name }} åˆ†æ”¯æ›´æ–°æ—¶ï¼Œæ­¤ Release ä¼šè¢«**è‡ªåŠ¨è¦†ç›–**
            ${{ inputs.is_prerelease && '- å¦‚éœ€ç¨³å®šç‰ˆæœ¬ï¼Œè¯·è®¿é—® [æ­£å¼ç‰ˆ Release](../../releases/tag/main-latest)' || '- å¦‚éœ€æµ‹è¯•æœ€æ–°åŠŸèƒ½ï¼Œè¯·è®¿é—® [Dev å¼€å‘ç‰ˆ Release](../../releases/tag/dev-latest)' }}
            ${{ inputs.create_version_tag && format('- åŽ†å²å½’æ¡£ç‰ˆæœ¬ï¼š[v{0}](../../releases/tag/v{0})', env.VERSION_NAME) || '' }}

            ### ðŸ”— å›ºå®šä¸‹è½½é“¾æŽ¥ï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼‰
            ```
            https://github.com/${{ github.repository }}/releases/download/${{ inputs.release_tag }}/${{ inputs.file_prefix }}${{ env.VERSION_NAME }}.zip
            ```

            ### ðŸ“¦ å®‰è£…æ–¹æ³•
            1. ä¸‹è½½ä¸Šé¢çš„ zip æ–‡ä»¶
            2. è§£åŽ‹ç¼©æ–‡ä»¶
            3. æ‰“å¼€ Chrome æµè§ˆå™¨ï¼Œè¿›å…¥ `chrome://extensions/`
            4. å¼€å¯å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£åŽ‹çš„æ‰©å±•ç¨‹åº"
            6. é€‰æ‹©è§£åŽ‹åŽçš„æ–‡ä»¶å¤¹

            ### ðŸ“ æœ€è¿‘æäº¤
            ${{ github.event.head_commit.message }}
          files: output/${{ inputs.file_prefix }}${{ env.VERSION_NAME }}.zip
          draft: false
          prerelease: ${{ inputs.is_prerelease }}
          make_latest: ${{ !inputs.is_prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # åˆ›å»ºç‰ˆæœ¬å½’æ¡£ Releaseï¼ˆä»…æ­£å¼ç‰ˆéœ€è¦ï¼‰
      - name: Create version archive Release
        if: inputs.create_version_tag
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION_NAME }}
          name: "ðŸ“¦ Droplink v${{ env.VERSION_NAME }}"
          body: |
            ## Droplink Chrome Extension v${{ env.VERSION_NAME }}

            è¿™æ˜¯ **v${{ env.VERSION_NAME }}** çš„åŽ†å²å½’æ¡£ç‰ˆæœ¬ã€‚

            ### ðŸ“¥ ä¸‹è½½
            - [droplink-v${{ env.VERSION_NAME }}.zip](https://github.com/${{ github.repository }}/releases/download/v${{ env.VERSION_NAME }}/droplink-v${{ env.VERSION_NAME }}.zip)

            ### ðŸ“¦ å®‰è£…æ–¹æ³•
            1. ä¸‹è½½ä¸Šé¢çš„ zip æ–‡ä»¶
            2. è§£åŽ‹ç¼©æ–‡ä»¶
            3. æ‰“å¼€ Chrome æµè§ˆå™¨ï¼Œè¿›å…¥ `chrome://extensions/`
            4. å¼€å¯å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£åŽ‹çš„æ‰©å±•ç¨‹åº"
            6. é€‰æ‹©è§£åŽ‹åŽçš„æ–‡ä»¶å¤¹

            ### â„¹ï¸ ç‰ˆæœ¬ä¿¡æ¯
            - **ç‰ˆæœ¬å·**: v${{ env.VERSION_NAME }}
            - **æž„å»ºæ—¶é—´**: ${{ env.BUILD_TIME }}
            - **æäº¤ SHA**: ${{ github.sha }}

            ---

            ### ðŸ”— èŽ·å–æœ€æ–°ç‰ˆæœ¬
            - [æ­£å¼ç‰ˆ (æœ€æ–°ç¨³å®šç‰ˆ)](../../releases/tag/main-latest)
            - [Dev å¼€å‘ç‰ˆ (æœ€æ–°)](../../releases/tag/dev-latest)
          files: output/droplink-v${{ env.VERSION_NAME }}.zip
          draft: false
          prerelease: false
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æž„å»ºä¿¡æ¯æ‘˜è¦
      - name: Build summary
        if: success()
        run: |
          echo "## âœ… æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·**: ${{ env.VERSION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ inputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤æ€»æ•°**: ${{ env.COMMIT_COUNT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: ${{ env.BUILD_TIME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ å›ºå®šä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/download/${{ inputs.release_tag }}/${{ inputs.file_prefix }}${{ env.VERSION_NAME }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
