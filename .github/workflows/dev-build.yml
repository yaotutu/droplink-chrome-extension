name: Chrome Extension Dev Build

on:
  # ç›‘å¬ dev åˆ†æ”¯çš„æŽ¨é€
  push:
    branches:
      - dev

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# æŽˆäºˆ GitHub Actions åˆ›å»º Release çš„æƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»º/æ›´æ–° Release å’Œ Tag

jobs:
  build:
    name: æž„å»º Dev ç‰ˆæœ¬
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•ï¼Œç”¨äºŽè®¡ç®—æäº¤æ€»æ•°

      # è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # è®¾ç½® pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      # èŽ·å– pnpm store ç›®å½•
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # ç¼“å­˜ä¾èµ–
      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # è®¾ç½®ç‰ˆæœ¬å·ï¼ˆåŸºäºŽ Git æäº¤æ€»æ•°ï¼Œç¡®ä¿ dev å’Œ main ç‰ˆæœ¬å·ä¸€è‡´ï¼‰
      - name: è®¾ç½®ç‰ˆæœ¬å·
        id: version
        run: |
          # ä½¿ç”¨ Git æäº¤æ€»æ•°ä½œä¸ºç‰ˆæœ¬å·åŸºå‡†
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION_NAME="1.0.${COMMIT_COUNT}"
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
          echo "ðŸ“¦ Dev ç‰ˆæœ¬å·: $VERSION_NAME"
          echo "ðŸ“Š åŸºäºŽ Git æäº¤æ€»æ•°: $COMMIT_COUNT"
          echo "ðŸ• æž„å»ºæ—¶é—´: $BUILD_TIME"

          # æ›´æ–° package.json çš„ç‰ˆæœ¬å·ï¼ˆä»…ç”¨äºŽæž„å»ºï¼Œä¸æäº¤ï¼‰
          npm version $VERSION_NAME --no-git-tag-version --allow-same-version

      # æž„å»ºæ‰©å±•
      - name: Build extension
        run: pnpm build

      # æ‰“åŒ…æ‰©å±•
      - name: Package extension
        run: pnpm package

      # é‡å‘½å zip æ–‡ä»¶
      - name: Rename package
        run: |
          mkdir -p output
          cp build/chrome-mv3-prod.zip output/droplink-dev-${{ env.VERSION_NAME }}.zip
          echo "âœ… æ‰©å±•åŒ…å·²é‡å‘½åä¸º: droplink-dev-${{ env.VERSION_NAME }}.zip"

      # ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: droplink-dev-${{ env.VERSION_NAME }}
          path: output/droplink-dev-${{ env.VERSION_NAME }}.zip
          retention-days: 30

      # è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Release (è¦†ç›–å¼å‘å¸ƒ dev-latest)
      - name: Create or Update Dev Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: dev-latest
          name: "ðŸš€ Dev å¼€å‘ç‰ˆ (æœ€æ–°)"
          body: |
            ## ðŸ“¦ Droplink Chrome Extension Dev å¼€å‘ç‰ˆ - è‡ªåŠ¨æž„å»º

            **ç‰ˆæœ¬å·**: `${{ env.VERSION_NAME }}`
            **æž„å»ºåˆ†æ”¯**: `dev`
            **æäº¤ SHA**: `${{ github.sha }}`
            **æž„å»ºæ—¶é—´**: `${{ env.BUILD_TIME }}`

            ---

            ### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
            - è¿™æ˜¯**å¼€å‘æµ‹è¯•ç‰ˆæœ¬**ï¼Œå¯èƒ½åŒ…å«æœªå®Œæˆçš„åŠŸèƒ½æˆ– Bug
            - æ¯æ¬¡ dev åˆ†æ”¯æ›´æ–°æ—¶ï¼Œæ­¤ Release ä¼šè¢«**è‡ªåŠ¨è¦†ç›–**
            - å¦‚éœ€ç¨³å®šç‰ˆæœ¬ï¼Œè¯·è®¿é—® [æ­£å¼ç‰ˆ Release](../../releases/tag/main-latest)

            ### ðŸ”— å›ºå®šä¸‹è½½é“¾æŽ¥ï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼‰
            ```
            https://github.com/${{ github.repository }}/releases/download/dev-latest/droplink-dev-${{ env.VERSION_NAME }}.zip
            ```

            ### ðŸ“¦ å®‰è£…æ–¹æ³•
            1. ä¸‹è½½ä¸Šé¢çš„ zip æ–‡ä»¶
            2. è§£åŽ‹ç¼©æ–‡ä»¶
            3. æ‰“å¼€ Chrome æµè§ˆå™¨ï¼Œè¿›å…¥ `chrome://extensions/`
            4. å¼€å¯å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£åŽ‹çš„æ‰©å±•ç¨‹åº"
            6. é€‰æ‹©è§£åŽ‹åŽçš„æ–‡ä»¶å¤¹

            ### ðŸ“ æœ€è¿‘æäº¤
            ${{ github.event.head_commit.message }}
          files: output/droplink-dev-${{ env.VERSION_NAME }}.zip
          draft: false
          prerelease: true  # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æž„å»ºä¿¡æ¯æ‘˜è¦
      - name: Build summary
        run: |
          echo "## ðŸš€ Dev æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·**: ${{ env.VERSION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: ${{ env.BUILD_TIME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ å›ºå®šä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}/releases/download/dev-latest/droplink-dev-${{ env.VERSION_NAME }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
